<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soccer Practice Tracker</title>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #4CAF50, #2196F3);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Auth Screen */
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 300px;
            margin: 0 auto;
        }

        .auth-form input {
            padding: 15px;
            border: 3px solid #4CAF50;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
        }

        .auth-form button {
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .auth-form button:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .auth-form button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .auth-toggle {
            margin-top: 15px;
            color: #666;
            cursor: pointer;
            text-decoration: underline;
        }

        /* Dashboard */
        .player-header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #FF6B6B;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        /* Forms */
        .form-group {
            margin: 20px 0;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 15px;
            border: 3px solid #4CAF50;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
        }

        .side-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .side-btn {
            padding: 15px 25px;
            border: 3px solid #4CAF50;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .side-btn.active {
            background: #4CAF50;
            color: white;
        }

        .timer-display {
            font-size: 48px;
            font-weight: bold;
            color: #FF6B6B;
            margin: 20px 0;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-danger {
            background: #FF6B6B;
            color: white;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Pack Opening */
        .pack-animation {
            text-align: center;
            padding: 40px;
        }

        .pack-image {
            font-size: 80px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pack-image:hover {
            transform: scale(1.1);
        }

        .reward-reveal {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px #FFD700; }
            50% { box-shadow: 0 0 40px #FFD700; }
        }

        .reward-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .reward-card {
            background: white;
            border: 3px solid #FFD700;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .reward-emoji {
            font-size: 40px;
            margin-bottom: 10px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: white;
            color: #333;
        }

        /* Drill Instructions */
        .drill-instructions {
            background: #E3F2FD;
            border-left: 5px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
            text-align: left;
        }

        /* Messages */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #c62828;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #2e7d32;
        }

        /* Achievement Popup */
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            animation: popup 3s ease-in-out;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        @keyframes popup {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            10%, 90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* Session History Table */
        .sessions-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .sessions-table th,
        .sessions-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .sessions-table th {
            background: #4CAF50;
            color: white;
            font-weight: bold;
        }

        .sessions-table tr:hover {
            background: #f8f8f8;
        }

        .sessions-table tr:last-child td {
            border-bottom: none;
        }

        /* Totals Summary */
        .totals-summary {
            background: linear-gradient(45deg, #E8F5E8, #F0F8FF);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .total-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .total-number {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }

        .total-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* Leaderboard */
        .leaderboard-filters {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #4CAF50;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .filter-btn.active {
            background: #4CAF50;
            color: white;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .leaderboard-table th {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            font-weight: bold;
        }

        .leaderboard-table tr:hover {
            background: #f8f8f8;
        }

        .leaderboard-table tr:last-child td {
            border-bottom: none;
        }

        .rank-cell {
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            width: 60px;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        .player-name {
            font-weight: bold;
            color: #333;
        }

        .current-user {
            background: #E8F5E8 !important;
            font-weight: bold;
        }

        /* Profile Tab */
        .profile-section {
            background: linear-gradient(45deg, #E8F5E8, #F0F8FF);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .avatar-display {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4CAF50, #2196F3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: white;
            margin: 0 auto;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .avatar-display:hover {
            transform: scale(1.05);
        }

        .avatar-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
            margin: 15px 0;
            max-width: 400px;
            margin: 15px auto;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .avatar-option:hover {
            border-color: #4CAF50;
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: #4CAF50;
            background: #E8F5E8;
        }

        .profile-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .profile-input-group {
            display: flex;
            flex-direction: column;
        }

        .profile-input-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .profile-input-group input,
        .profile-input-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .profile-input-group input:focus,
        .profile-input-group select:focus {
            border-color: #4CAF50;
            outline: none;
        }

        .foot-selector {
            display: flex;
            gap: 10px;
        }

        .foot-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .foot-btn.selected {
            border-color: #4CAF50;
            background: #E8F5E8;
            color: #4CAF50;
        }

        /* AI Coach */
        .ai-coach-section {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .coach-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .coach-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 15px;
        }

        .chat-container {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .chat-message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 10px;
            animation: fadeIn 0.5s ease-in;
        }

        .chat-message.user {
            background: rgba(255,255,255,0.2);
            margin-left: 20px;
            text-align: right;
        }

        .chat-message.coach {
            background: rgba(255,255,255,0.15);
            margin-right: 20px;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
        }

        .chat-send-btn {
            padding: 12px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .chat-send-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .chat-send-btn:disabled {
            background: rgba(255,255,255,0.1);
            cursor: not-allowed;
        }

        .quick-questions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .quick-question-btn {
            padding: 10px 15px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .quick-question-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .stats-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .side-selector {
                flex-direction: column;
            }
            
            .timer-display {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading Screen -->
        <div id="loadingScreen" class="card">
            <div class="loading">
                <div class="spinner"></div>
            </div>
            <p>Loading Soccer Practice Tracker...</p>
        </div>

        <!-- Authentication Screen -->
        <div id="authScreen" class="card hidden">
            <h1>‚öΩ Soccer Practice Tracker</h1>
            <p>Track your practice, earn rewards, become a soccer star!</p>
            
            <div class="auth-form">
                <input type="text" id="authUsername" placeholder="Your Name" maxlength="50" />
                <input type="email" id="authEmail" placeholder="Email Address" />
                <button id="authSubmit">Sign In</button>
                <div class="auth-toggle" id="authToggle">New player? Create account</div>
            </div>
            
            <div id="authError" class="error-message hidden"></div>
            <div id="authSuccess" class="success-message hidden"></div>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <!-- Player Header -->
            <div class="player-header">
                <h2 id="playerName">Welcome, Player!</h2>
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-number" id="playerTokens">0</div>
                        <div class="stat-label">Tokens</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="playerSessions">0</div>
                        <div class="stat-label">Sessions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="playerLevel">1</div>
                        <div class="stat-label">Level</div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="nav-tabs">
                <div class="nav-tab active" data-tab="practice">ü•Ö Practice</div>
                <div class="nav-tab" data-tab="rewards">üéÅ Rewards</div>
                <div class="nav-tab" data-tab="progress">üìä Progress</div>
                <div class="nav-tab" data-tab="leaderboard">üèÜ Leaderboard</div>
                <div class="nav-tab" data-tab="profile">üë§ Profile</div>
            </div>

            <!-- Practice Tab -->
            <div id="practiceTab" class="card">
                <!-- Drill Selection -->
                <div id="drillSelection">
                    <h3>Choose Your Drill</h3>
                    
                    <div class="form-group">
                        <label>Select Drill:</label>
                        <select id="drillSelect">
                            <option value="">Choose a drill...</option>
                        </select>
                    </div>

                    <div class="drill-instructions" id="drillInstructions" style="display:none;">
                        <strong>Instructions:</strong>
                        <p id="instructionText"></p>
                    </div>

                    <div class="form-group">
                        <label>Practice Side:</label>
                        <div class="side-selector">
                            <div class="side-btn active" data-side="both">Both Feet</div>
                            <div class="side-btn" data-side="left">Left Foot</div>
                            <div class="side-btn" data-side="right">Right Foot</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Practice Time (minutes):</label>
                        <input type="number" id="practiceTime" value="5" min="1" max="30" />
                    </div>

                    <button class="btn btn-primary" id="startPractice">Start Practice! ‚öΩ</button>
                </div>

                <!-- Practice Session -->
                <div id="practiceSession" class="hidden">
                    <h3 id="currentDrillName">Current Drill</h3>
                    <div class="timer-display" id="timerDisplay">5:00</div>
                    
                    <div class="timer-controls">
                        <button class="btn btn-secondary" id="pauseTimer">‚è∏Ô∏è Pause</button>
                        <button class="btn btn-danger" id="stopPractice">‚èπÔ∏è Stop</button>
                    </div>

                    <div class="form-group">
                        <label>Record Your Result:</label>
                        <input type="number" id="practiceResult" placeholder="e.g., 15 juggles" min="0" />
                    </div>
                </div>

                <!-- Session Complete -->
                <div id="sessionComplete" class="hidden">
                    <h3>üéâ Great Practice!</h3>
                    <div id="sessionResults"></div>
                    <button class="btn btn-primary" id="saveSession">Save & Earn Tokens!</button>
                    <button class="btn btn-secondary" id="newPractice">Practice Again</button>
                </div>
            </div>

            <!-- Rewards Tab -->
            <div id="rewardsTab" class="card hidden">
                <h3>üéÅ Reward Store</h3>
                <p>Spend your tokens to open packs!</p>
                
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-number" id="tokensDisplay">0</div>
                        <div class="stat-label">Available Tokens</div>
                    </div>
                </div>

                <div class="pack-animation">
                    <div class="pack-image" id="packImage">üì¶</div>
                    <h4>Mystery Pack</h4>
                    <p>Cost: 10 tokens</p>
                    <button class="btn btn-primary" id="openPack">Open Pack!</button>
                </div>

                <div id="packResults" class="hidden">
                    <div class="reward-reveal">
                        <h3>üåü You Got!</h3>
                        <div id="rewardContent"></div>
                    </div>
                    <button class="btn btn-secondary" id="closePackResults">Continue</button>
                </div>

                <div class="reward-grid" id="collectionGrid">
                    <h4 style="grid-column: 1 / -1;">Your Collection</h4>
                </div>
            </div>

            <!-- Progress Tab -->
            <div id="progressTab" class="card hidden">
                <h3>üìä Your Progress</h3>
                
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-number" id="totalDrills">0</div>
                        <div class="stat-label">Total Drills</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="bestStreak">0</div>
                        <div class="stat-label">Best Streak</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalTime">0</div>
                        <div class="stat-label">Minutes Practiced</div>
                    </div>
                </div>

                <div id="recentSessions">
                    <h4>Recent Sessions</h4>
                    <div id="sessionHistory">
                        <table class="sessions-table" id="sessionsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Drill</th>
                                    <th>Duration</th>
                                    <th>Result</th>
                                    <th>Tokens</th>
                                </tr>
                            </thead>
                            <tbody id="sessionsTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #666;">No practice sessions yet. Start practicing to see your progress!</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="totals-summary">
                    <h4 style="text-align: center; margin-bottom: 15px;">üìà Practice Totals</h4>
                    <div class="totals-grid">
                        <div class="total-item">
                            <div class="total-number" id="weeklyTotal">0</div>
                            <div class="total-label">This Week<br>Sessions</div>
                        </div>
                        <div class="total-item">
                            <div class="total-number" id="monthlyTotal">0</div>
                            <div class="total-label">This Month<br>Sessions</div>
                        </div>
                        <div class="total-item">
                            <div class="total-number" id="yearlyTotal">0</div>
                            <div class="total-label">This Year<br>Sessions</div>
                        </div>
                        <div class="total-item">
                            <div class="total-number" id="weeklyMinutes">0</div>
                            <div class="total-label">This Week<br>Minutes</div>
                        </div>
                        <div class="total-item">
                            <div class="total-number" id="monthlyMinutes">0</div>
                            <div class="total-label">This Month<br>Minutes</div>
                        </div>
                            <div class="total-item">
                            <div class="total-number" id="yearlyMinutes">0</div>
                            <div class="total-label">This Year<br>Minutes</div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-danger" id="signOut">Sign Out</button>
            </div>

            <!-- Leaderboard Tab -->
            <div id="leaderboardTab" class="card hidden">
                <h3>üèÜ Leaderboard</h3>
                <p>See how you rank against other players!</p>
                
                <div class="leaderboard-filters">
                    <div class="filter-btn active" data-period="daily">üìÖ Daily</div>
                    <div class="filter-btn" data-period="weekly">üìä Weekly</div>
                    <div class="filter-btn" data-period="monthly">üìà Monthly</div>
                    <div class="filter-btn" data-period="alltime">üèÜ All Time</div>
                </div>

                <div id="leaderboardContent">
                    <table class="leaderboard-table" id="leaderboardTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Sessions</th>
                                <th>Minutes</th>
                                <th>Tokens</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #666;">Loading leaderboard...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profileTab" class="card hidden">
                <h3>üë§ Player Profile</h3>
                
                <div class="profile-section">
                    <div class="profile-header">
                        <div class="avatar-container">
                            <div class="avatar-display" id="avatarDisplay">‚öΩ</div>
                        </div>
                        <h4 id="profileDisplayName">Player Name</h4>
                        <p style="color: #666;">Level <span id="profileLevel">1</span> ‚Ä¢ <span id="profileTokens">0</span> Tokens</p>
                    </div>

                    <div class="profile-form">
                        <div class="profile-input-group">
                            <label>Choose Avatar:</label>
                            <div class="avatar-options" id="avatarOptions"></div>
                        </div>
                        
                        <div class="profile-input-group">
                            <label>Display Name:</label>
                            <input type="text" id="profileName" placeholder="Your name" maxlength="50" />
                        </div>
                        
                        <div class="profile-input-group">
                            <label>Team Name:</label>
                            <input type="text" id="profileTeam" placeholder="Your team name" maxlength="50" />
                        </div>
                        
                        <div class="profile-input-group">
                            <label>Favorite Foot:</label>
                            <div class="foot-selector">
                                <div class="foot-btn" data-foot="L">Left ü¶∂</div>
                                <div class="foot-btn" data-foot="R">Right ü¶∂</div>
                            </div>
                        </div>
                        
                        <div class="profile-input-group">
                            <label>Favorite Player:</label>
                            <input type="text" id="profileFavoritePlayer" placeholder="e.g., Messi, Ronaldo" maxlength="50" />
                        </div>
                        
                        <div class="profile-input-group">
                            <label>State:</label>
                            <select id="profileState">
                                <option value="">Select your state</option>
                            </select>
                        </div>
                        
                        <div class="profile-input-group">
                            <label>Age:</label>
                            <input type="number" id="profileAge" min="5" max="99" placeholder="Your age" />
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" id="saveProfile">üíæ Save Profile</button>
                    </div>
                </div>

                <!-- AI Coach Section -->
                <div class="ai-coach-section">
                    <div class="coach-header">
                        <div class="coach-avatar">üß†</div>
                        <h3>AI Coach Sarah</h3>
                        <p>Your personal soccer development coach powered by neuroscience</p>
                    </div>

                    <div class="quick-questions">
                        <button class="quick-question-btn" data-question="analyze">üìä Analyze my progress</button>
                        <button class="quick-question-btn" data-question="improve">üöÄ How can I improve?</button>
                        <button class="quick-question-btn" data-question="motivation">üí™ Motivate me!</button>
                        <button class="quick-question-btn" data-question="drills">‚öΩ Suggest drills for me</button>
                    </div>

                    <div class="chat-container" id="chatContainer">
                        <div class="chat-message coach">
                            <strong>Coach Sarah:</strong> Hi there! üëã I'm your AI soccer coach, and I'm here to help you become the best player you can be! I use neuroscience principles to create personalized training advice just for you. Ask me anything about your soccer development!
                        </div>
                    </div>

                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Ask your coach anything..." maxlength="500" />
                        <button id="chatSendBtn" class="chat-send-btn">Send üöÄ</button>
                    </div>
                </div>

                <button class="btn btn-danger" id="signOutProfile" style="margin-top: 20px;">Sign Out</button>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const SUPABASE_URL = 'https://obkygloivckoidjnhnsh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ia3lnbG9pdmNrb2lkam5obnNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1Mjg4MDAsImV4cCI6MjA2NDEwNDgwMH0.I1zaHPxlm11cVNoklpn5rltAUo-HohupZuSNADNeAlw';
        
        // Backend API endpoint - will be configured when backend is set up
        const BACKEND_URL = 'https://soccer-practice-tracker.vercel.app'; // Change this to your deployed backend URL
        
        // Initialize Supabase client
        let supabase;
        
        // ===== REWARD SYSTEM =====
        const REWARDS = {
            players: [
                { name: 'Lightning Leo', emoji: '‚ö°', rarity: 'common' },
                { name: 'Mighty Mia', emoji: 'üí™', rarity: 'common' },
                { name: 'Speedy Sam', emoji: 'üèÉ', rarity: 'common' },
                { name: 'Skillful Sarah', emoji: 'üéØ', rarity: 'common' },
                { name: 'Captain Carlos', emoji: 'üëë', rarity: 'rare' },
                { name: 'Golden Grace', emoji: 'ü•á', rarity: 'rare' },
                { name: 'Rocket Rosa', emoji: 'üöÄ', rarity: 'rare' },
                { name: 'Thunder Thor', emoji: '‚ö°', rarity: 'legendary' },
                { name: 'Diamond Dana', emoji: 'üíé', rarity: 'legendary' },
                { name: 'Master Mo', emoji: 'üèÜ', rarity: 'legendary' }
            ],
            badges: [
                { name: 'First Goal', emoji: 'ü•Ö', rarity: 'common' },
                { name: 'Practice Streak', emoji: 'üî•', rarity: 'common' },
                { name: 'Quick Learner', emoji: 'üìö', rarity: 'common' },
                { name: 'Juggling Master', emoji: 'ü§π', rarity: 'rare' },
                { name: 'Speed Demon', emoji: 'üí®', rarity: 'rare' },
                { name: 'Skill Champion', emoji: 'üèÖ', rarity: 'rare' },
                { name: 'Soccer Legend', emoji: 'üèÜ', rarity: 'legendary' },
                { name: 'Perfect Player', emoji: '‚≠ê', rarity: 'legendary' }
            ],
            items: [
                { name: 'Magic Boots', emoji: 'üëü', rarity: 'common' },
                { name: 'Lucky Ball', emoji: '‚öΩ', rarity: 'common' },
                { name: 'Training Cone', emoji: 'üî∂', rarity: 'common' },
                { name: 'Power Gloves', emoji: 'üß§', rarity: 'rare' },
                { name: 'Champion Jersey', emoji: 'üëï', rarity: 'rare' },
                { name: 'Victory Whistle', emoji: 'üîî', rarity: 'rare' },
                { name: 'Golden Trophy', emoji: 'üèÜ', rarity: 'legendary' },
                { name: 'Crystal Ball', emoji: 'üîÆ', rarity: 'legendary' }
            ]
        };

        // ===== APP STATE =====
        let currentUser = null;
        let currentSession = null;
        let timer = null;
        let timeRemaining = 0;
        let isTimerRunning = false;
        let drillsData = [];
        let isAuthMode = 'signin';
        let chatHistory = [];

        // Avatar options
        const AVATAR_OPTIONS = ['‚öΩ', 'üèÉ‚Äç‚ôÇÔ∏è', 'üèÉ‚Äç‚ôÄÔ∏è', 'üë®‚Äçüíº', 'üë©‚Äçüíº', 'üë®‚Äçüéì', 'üë©‚Äçüéì', 'ü¶∏‚Äç‚ôÇÔ∏è', 'ü¶∏‚Äç‚ôÄÔ∏è', 'üë®‚ÄçüöÄ', 'üë©‚ÄçüöÄ', 'üßë‚Äçüíª'];

        // US States
        const US_STATES = [
            'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 'Delaware',
            'Florida', 'Georgia', 'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky',
            'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi',
            'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey', 'New Mexico',
            'New York', 'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania',
            'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont',
            'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming'
        ];

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeApp();
        });

        async function initializeApp() {
            try {
                // Initialize Supabase
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Load drills from database
                await loadDrills();
                
                // Setup event listeners
                setupEventListeners();
                
                // Hide loading, show auth
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize app. Please check your internet connection.');
            }
        }

        async function loadDrills() {
            try {
                const { data, error } = await supabase
                    .from('drills')
                    .select('*')
                    .order('name');

                if (error) throw error;

                drillsData = data;
                populateDrillSelect();
            } catch (error) {
                console.error('Error loading drills:', error);
                // Use fallback drills if database fails
                useFallbackDrills();
            }
        }

        function useFallbackDrills() {
            drillsData = [
                { id: 'juggling', name: 'Juggling', instructions: 'Keep the ball in the air using your feet, thighs, and head. Count how many touches you make before the ball hits the ground.', result_label: 'touches' },
                { id: 'wall_passes', name: 'Wall Passes', instructions: 'Stand 3 feet from a wall. Pass the ball against the wall and control it when it returns. Count successful passes.', result_label: 'passes' },
                { id: 'cone_weaving', name: 'Cone Weaving', instructions: 'Set up 5 cones in a line, 2 yards apart. Dribble through them as fast as possible. Count completed runs.', result_label: 'runs' },
                { id: 'target_shooting', name: 'Target Shooting', instructions: 'Place targets in corners of the goal. Take shots trying to hit the targets. Count successful hits.', result_label: 'goals' },
                { id: 'step_overs', name: 'Step Overs', instructions: 'Practice step-over moves. Step over the ball with one foot, then push it away with the outside of the other foot.', result_label: 'moves' },
                { id: 'quick_touches', name: 'Quick Touches', instructions: 'Use the inside of both feet to tap the ball back and forth quickly. Count total touches in the time limit.', result_label: 'touches' },
                { id: 'first_touch', name: 'First Touch Control', instructions: 'Throw the ball up and control it with different parts of your foot. Count successful controls.', result_label: 'controls' },
                { id: 'turning', name: 'Turning Practice', instructions: 'Practice different turns: inside cut, outside cut, pull back. Count completed turns.', result_label: 'turns' },
                { id: 'weak_foot', name: 'Weak Foot Training', instructions: 'Use only your weak foot for all touches. Practice passing, shooting, and dribbling.', result_label: 'touches' },
                { id: 'agility_ladder', name: 'Agility Footwork', instructions: 'Use cones to create ladder pattern. Practice quick feet movements through the pattern.', result_label: 'runs' }
            ];
            populateDrillSelect();
        }

        function populateDrillSelect() {
            const drillSelect = document.getElementById('drillSelect');
            drillSelect.innerHTML = '<option value="">Choose a drill...</option>';
            
            drillsData.forEach(drill => {
                const option = document.createElement('option');
                option.value = drill.id;
                option.textContent = drill.name;
                drillSelect.appendChild(option);
            });
        }

        function setupEventListeners() {
            // Auth
            document.getElementById('authSubmit').addEventListener('click', handleAuth);
            document.getElementById('authToggle').addEventListener('click', toggleAuthMode);
            
            // Enter key support for auth
            document.getElementById('authUsername').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAuth();
            });
            document.getElementById('authEmail').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAuth();
            });

            // Navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });

            // Drill selection
            document.getElementById('drillSelect').addEventListener('change', showDrillInstructions);
            
            // Side selection
            document.querySelectorAll('.side-btn').forEach(btn => {
                btn.addEventListener('click', (e) => selectSide(e.target));
            });

            // Practice controls
            document.getElementById('startPractice').addEventListener('click', startPractice);
            document.getElementById('pauseTimer').addEventListener('click', toggleTimer);
            document.getElementById('stopPractice').addEventListener('click', stopPractice);
            document.getElementById('saveSession').addEventListener('click', saveSession);
            document.getElementById('newPractice').addEventListener('click', newPractice);

            // Rewards
            document.getElementById('openPack').addEventListener('click', openPack);
            document.getElementById('closePackResults').addEventListener('click', closePackResults);

            // Leaderboard filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchLeaderboardPeriod(e.target.dataset.period));
            });

            // Profile
            document.getElementById('saveProfile').addEventListener('click', saveProfile);
            document.getElementById('signOutProfile').addEventListener('click', signOut);
            
            // Avatar selection
            document.getElementById('avatarDisplay').addEventListener('click', toggleAvatarSelection);
            
            // Foot selection
            document.querySelectorAll('.foot-btn').forEach(btn => {
                btn.addEventListener('click', (e) => selectFoot(e.target));
            });

            // AI Coach
            document.getElementById('chatSendBtn').addEventListener('click', sendChatMessage);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            document.querySelectorAll('.quick-question-btn').forEach(btn => {
                btn.addEventListener('click', (e) => sendQuickQuestion(e.target.dataset.question));
            });

            // Other
            document.getElementById('signOut').addEventListener('click', signOut);
        }

        // ===== AUTHENTICATION =====
        async function handleAuth() {
            const username = document.getElementById('authUsername').value.trim();
            const email = document.getElementById('authEmail').value;
            const submitBtn = document.getElementById('authSubmit');
            
            if (!username || !email) {
                showError('Please enter both name and email address');
                return;
            }

            if (username.length < 2) {
                showError('Name must be at least 2 characters long');
                return;
            }

            if (!email.includes('@')) {
                showError('Please enter a valid email address');
                return;
            }

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = isAuthMode === 'signin' ? 'Signing In...' : 'Creating Account...';

            try {
                if (isAuthMode === 'signup') {
                    await createAccount(username, email);
                } else {
                    await signInUser(username, email);
                }
            } catch (error) {
                console.error('Auth error:', error);
                showError(error.message || 'Authentication failed. Please try again.');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = isAuthMode === 'signin' ? 'Sign In' : 'Create Account';
            }
        }

        async function createAccount(username, email) {
            try {
                // Hash email (simple method - in production use proper hashing)
                const emailHash = await hashPassword(email);
                
                // Check if username already exists
                const { data: existing } = await supabase
                    .from('players')
                    .select('username')
                    .eq('username', username.toLowerCase())
                    .single();

                if (existing) {
                    throw new Error('Username already exists. Please choose a different name.');
                }

                // Create new player
                const { data, error } = await supabase
                    .from('players')
                    .insert([{
                        username: username.toLowerCase(),
                        email: email,
                        email_hash: emailHash,
                        password_hash: emailHash, // Temporary compatibility
                        display_name: username,
                        tokens: 50,
                        total_sessions: 0,
                        level: 1,
                        avatar: '‚öΩ',
                        team_name: '',
                        favorite_foot: 'R',
                        favorite_player: '',
                        state: '',
                        age: null
                    }])
                    .select()
                    .single();

                if (error) throw error;

                showSuccess('Account created successfully! Welcome to Soccer Practice Tracker!');
                
                // Auto sign in
                setTimeout(() => {
                    currentUser = {
                        id: data.id,
                        username: data.username,
                        name: data.display_name,
                        tokens: data.tokens,
                        sessions: data.total_sessions,
                        level: data.level,
                        avatar: data.avatar,
                        team_name: data.team_name,
                        favorite_foot: data.favorite_foot,
                        favorite_player: data.favorite_player,
                        state: data.state,
                        age: data.age
                    };
                    showMainApp();
                }, 1500);

            } catch (error) {
                throw error;
            }
        }

        async function signInUser(username, email) {
            try {
                // Get user from database
                const { data, error } = await supabase
                    .from('players')
                    .select('*')
                    .eq('username', username.toLowerCase())
                    .single();

                if (error || !data) {
                    throw new Error('User not found. Please check your name or create a new account.');
                }

                // Verify email
                const isValidEmail = await verifyPassword(email, data.email_hash);
                if (!isValidEmail) {
                    throw new Error('Incorrect email address. Please try again.');
                }

                // Update last login
                await supabase
                    .from('players')
                    .update({ last_login: new Date().toISOString() })
                    .eq('id', data.id);

                // Set current user
                currentUser = {
                    id: data.id,
                    username: data.username,
                    name: data.display_name,
                    tokens: data.tokens,
                    sessions: data.total_sessions,
                    level: data.level,
                    avatar: data.avatar || '‚öΩ',
                    team_name: data.team_name || '',
                    favorite_foot: data.favorite_foot || 'R',
                    favorite_player: data.favorite_player || '',
                    state: data.state || '',
                    age: data.age
                };

                showMainApp();

            } catch (error) {
                throw error;
            }
        }

        async function hashPassword(email) {
            // Simple hash for demo - use bcrypt or similar in production
            const encoder = new TextEncoder();
            const data = encoder.encode(email + 'soccer_salt_2024');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function verifyPassword(email, hash) {
            const inputHash = await hashPassword(email);
            return inputHash === hash;
        }

        function toggleAuthMode() {
            const toggle = document.getElementById('authToggle');
            const submit = document.getElementById('authSubmit');
            
            if (isAuthMode === 'signin') {
                isAuthMode = 'signup';
                submit.textContent = 'Create Account';
                toggle.textContent = 'Already have an account? Sign in';
            } else {
                isAuthMode = 'signin';
                submit.textContent = 'Sign In';
                toggle.textContent = 'New player? Create account';
            }
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            updatePlayerDisplay();
            loadUserData();
        }

        async function loadUserData() {
            try {
                // Load user's collection
                await loadUserCollection();
                
                // Load user's recent sessions
                await loadRecentSessions();
                
                // Update displays
                updateRewardsDisplay();
                updateProgressDisplay();
                
                // Initialize profile data
                setupProfileForm();
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadUserCollection() {
            try {
                const { data, error } = await supabase
                    .from('player_collection')
                    .select('*')
                    .eq('player_id', currentUser.id)
                    .order('obtained_at', { ascending: false });

                if (error) throw error;

                currentUser.collection = data || [];
            } catch (error) {
                console.error('Error loading collection:', error);
                currentUser.collection = [];
            }
        }

        async function loadRecentSessions() {
            try {
                const { data, error } = await supabase
                    .from('practice_sessions')
                    .select(`
                        *,
                        drills(name, result_label)
                    `)
                    .eq('player_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                currentUser.history = data || [];
            } catch (error) {
                console.error('Error loading sessions:', error);
                currentUser.history = [];
            }
        }

        function updatePlayerDisplay() {
            document.getElementById('playerName').textContent = `Welcome, ${currentUser.name}!`;
            document.getElementById('playerTokens').textContent = currentUser.tokens;
            document.getElementById('playerSessions').textContent = currentUser.sessions;
            document.getElementById('playerLevel').textContent = currentUser.level;
            document.getElementById('tokensDisplay').textContent = currentUser.tokens;
        }

        // ===== NAVIGATION =====
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });

            // Show/hide tab content
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.getElementById(tabName + 'Tab').classList.remove('hidden');

            // Load data if needed
            if (tabName === 'progress') {
                updateProgressDisplay();
            } else if (tabName === 'rewards') {
                updateRewardsDisplay();
            } else if (tabName === 'leaderboard') {
                loadLeaderboard('daily');
            } else if (tabName === 'profile') {
                loadProfileData();
            }
        }

        // ===== DRILL FUNCTIONS =====
        function showDrillInstructions() {
            const drillId = document.getElementById('drillSelect').value;
            const instructionsDiv = document.getElementById('drillInstructions');
            const instructionText = document.getElementById('instructionText');
            
            const drill = drillsData.find(d => d.id === drillId);
            if (drill) {
                instructionText.textContent = drill.instructions;
                instructionsDiv.style.display = 'block';
            } else {
                instructionsDiv.style.display = 'none';
            }
        }

        function selectSide(selectedBtn) {
            document.querySelectorAll('.side-btn').forEach(btn => btn.classList.remove('active'));
            selectedBtn.classList.add('active');
        }

        function startPractice() {
            const drillId = document.getElementById('drillSelect').value;
            const side = document.querySelector('.side-btn.active').dataset.side;
            const time = parseInt(document.getElementById('practiceTime').value);

            if (!drillId) {
                showError('Please select a drill first!');
                return;
            }

            const drill = drillsData.find(d => d.id === drillId);
            currentSession = {
                drillId: drillId,
                drillName: drill.name,
                resultLabel: drill.result_label,
                side: side,
                duration: time,
                startTime: new Date()
            };

            // Show practice session
            document.getElementById('drillSelection').classList.add('hidden');
            document.getElementById('practiceSession').classList.remove('hidden');
            document.getElementById('currentDrillName').textContent = currentSession.drillName;

            // Clear previous result
            document.getElementById('practiceResult').value = '';
            document.getElementById('practiceResult').placeholder = `e.g., 15 ${drill.result_label}`;

            // Start timer
            timeRemaining = time * 60;
            updateTimerDisplay();
            startTimer();
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            
            timer = setInterval(() => {
                if (timeRemaining > 0) {
                    timeRemaining--;
                    updateTimerDisplay();
                } else {
                    // Time's up!
                    clearInterval(timer);
                    completeSession();
                }
            }, 1000);
            
            isTimerRunning = true;
            document.getElementById('pauseTimer').textContent = '‚è∏Ô∏è Pause';
        }

        function toggleTimer() {
            if (isTimerRunning) {
                clearInterval(timer);
                isTimerRunning = false;
                document.getElementById('pauseTimer').textContent = '‚ñ∂Ô∏è Resume';
            } else {
                startTimer();
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function stopPractice() {
            if (confirm('Are you sure you want to stop this practice session?')) {
                clearInterval(timer);
                completeSession();
            }
        }

        function completeSession() {
            clearInterval(timer);
            isTimerRunning = false;
            
            document.getElementById('practiceSession').classList.add('hidden');
            document.getElementById('sessionComplete').classList.remove('hidden');
            
            const timeSpent = currentSession.duration - Math.floor(timeRemaining / 60);
            document.getElementById('sessionResults').innerHTML = `
                <p><strong>Drill:</strong> ${currentSession.drillName}</p>
                <p><strong>Time Practiced:</strong> ${timeSpent} minutes</p>
                <p><strong>Side:</strong> ${currentSession.side}</p>
                <p><strong>Record your ${currentSession.resultLabel} below!</strong></p>
            `;
        }

        async function saveSession() {
            const result = parseInt(document.getElementById('practiceResult').value) || 0;
            const saveBtn = document.getElementById('saveSession');
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                // Calculate tokens earned
                let tokensEarned = 5; // Base tokens
                if (result > 0) tokensEarned += Math.min(Math.floor(result / 5), 20); // Performance bonus
                
                // Save session to database
                const { error: sessionError } = await supabase
                    .from('practice_sessions')
                    .insert([{
                        player_id: currentUser.id,
                        drill_id: currentSession.drillId,
                        side: currentSession.side,
                        duration_minutes: currentSession.duration,
                        result: result,
                        tokens_earned: tokensEarned
                    }]);

                if (sessionError) throw sessionError;

                // Update player stats
                const newTokens = currentUser.tokens + tokensEarned;
                const newSessions = currentUser.sessions + 1;
                const newLevel = Math.floor(newSessions / 10) + 1;
                const leveledUp = newLevel > currentUser.level;

                const { error: updateError } = await supabase
                    .from('players')
                    .update({
                        tokens: newTokens,
                        total_sessions: newSessions,
                        level: newLevel
                    })
                    .eq('id', currentUser.id);

                if (updateError) throw updateError;

                // Update local user data
                currentUser.tokens = newTokens;
                currentUser.sessions = newSessions;
                currentUser.level = newLevel;

                // Show achievements
                if (leveledUp) {
                    showAchievement(`üéâ Level Up! You're now Level ${newLevel}!`);
                    tokensEarned += 25; // Level up bonus
                    
                    // Update tokens with bonus
                    await supabase
                        .from('players')
                        .update({ tokens: newTokens + 25 })
                        .eq('id', currentUser.id);
                    currentUser.tokens += 25;
                }

                showAchievement(`üéâ Great job! You earned ${tokensEarned} tokens!`);
                
                updatePlayerDisplay();
                await loadRecentSessions();
                newPractice();

            } catch (error) {
                console.error('Error saving session:', error);
                showError('Failed to save session. Please try again.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save & Earn Tokens!';
            }
        }

        function newPractice() {
            // Reset forms
            document.getElementById('drillSelect').value = '';
            document.getElementById('practiceResult').value = '';
            document.getElementById('practiceTime').value = 5;
            document.getElementById('drillInstructions').style.display = 'none';
            
            // Reset side selection
            document.querySelectorAll('.side-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.side-btn[data-side="both"]').classList.add('active');
            
            // Show drill selection
            document.getElementById('sessionComplete').classList.add('hidden');
            document.getElementById('drillSelection').classList.remove('hidden');
            
            currentSession = null;
        }

        // ===== REWARDS SYSTEM =====
        async function openPack() {
            if (currentUser.tokens < 10) {
                showError('You need 10 tokens to open a pack!');
                return;
            }

            const openBtn = document.getElementById('openPack');
            openBtn.disabled = true;
            openBtn.textContent = 'Opening...';

            try {
                // Deduct tokens
                const newTokens = currentUser.tokens - 10;
                await supabase
                    .from('players')
                    .update({ tokens: newTokens })
                    .eq('id', currentUser.id);

                currentUser.tokens = newTokens;

                // Generate random reward
                const rewardTypes = ['players', 'badges', 'items'];
                const randomType = rewardTypes[Math.floor(Math.random() * rewardTypes.length)];
                const rewards = REWARDS[randomType];
                const randomReward = rewards[Math.floor(Math.random() * rewards.length)];

                // Add to collection (if not already owned)
                const { error: collectionError } = await supabase
                    .from('player_collection')
                    .insert([{
                        player_id: currentUser.id,
                        item_type: randomType.slice(0, -1), // Remove 's' from end
                        item_name: randomReward.name,
                        item_emoji: randomReward.emoji,
                        rarity: randomReward.rarity
                    }])
                    .select();

                // If item already exists, that's okay - just show it
                
                // Show pack opening animation
                document.getElementById('packImage').textContent = 'üéÅ';
                setTimeout(() => {
                    showPackResults(randomReward);
                }, 1000);

                updatePlayerDisplay();
                await loadUserCollection();

            } catch (error) {
                console.error('Error opening pack:', error);
                showError('Failed to open pack. Please try again.');
            } finally {
                openBtn.disabled = false;
                openBtn.textContent = 'Open Pack!';
            }
        }

        function showPackResults(reward) {
            document.getElementById('rewardContent').innerHTML = `
                <div style="font-size: 60px; margin: 20px 0;">${reward.emoji}</div>
                <h3>${reward.name}</h3>
                <p>Rarity: ${reward.rarity.toUpperCase()}</p>
            `;
            
            document.getElementById('packResults').classList.remove('hidden');
        }

        function closePackResults() {
            document.getElementById('packResults').classList.add('hidden');
            document.getElementById('packImage').textContent = 'üì¶';
            updateRewardsDisplay();
        }

        function updateRewardsDisplay() {
            const grid = document.getElementById('collectionGrid');
            grid.innerHTML = '<h4 style="grid-column: 1 / -1;">Your Collection</h4>';

            if (!currentUser.collection || currentUser.collection.length === 0) {
                grid.innerHTML += '<p style="grid-column: 1 / -1; color: #666;">No items yet. Open packs to start your collection!</p>';
                return;
            }

            currentUser.collection.forEach(item => {
                const card = document.createElement('div');
                card.className = 'reward-card';
                card.innerHTML = `
                    <div class="reward-emoji">${item.item_emoji}</div>
                    <div style="font-weight: bold; margin-bottom: 5px;">${item.item_name}</div>
                    <div style="font-size: 12px; color: #666;">${item.rarity}</div>
                `;
                grid.appendChild(card);
            });
        }

        // ===== PROGRESS TRACKING =====
        function updateProgressDisplay() {
            if (!currentUser.history) return;

            // Calculate stats
            const totalDrills = currentUser.history.length;
            const totalTime = currentUser.history.reduce((sum, session) => sum + session.duration_minutes, 0);
            
            // Calculate best streak (consecutive days)
            let bestStreak = 0;
            let currentStreak = 0;
            let lastDate = null;

            const sortedSessions = [...currentUser.history].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            
            sortedSessions.forEach(session => {
                const sessionDate = new Date(session.created_at).toDateString();
                if (lastDate && sessionDate !== lastDate) {
                    const daysDiff = (new Date(sessionDate) - new Date(lastDate)) / (1000 * 60 * 60 * 24);
                    if (daysDiff === 1) {
                        currentStreak++;
                    } else {
                        bestStreak = Math.max(bestStreak, currentStreak);
                        currentStreak = 1;
                    }
                } else if (!lastDate) {
                    currentStreak = 1;
                }
                lastDate = sessionDate;
            });
            bestStreak = Math.max(bestStreak, currentStreak);

            // Update display
            document.getElementById('totalDrills').textContent = totalDrills;
            document.getElementById('bestStreak').textContent = bestStreak;
            document.getElementById('totalTime').textContent = totalTime;

            // Update sessions table
            updateSessionsTable();
            
            // Update totals
            updateTotalsSummary();
        }

        function updateSessionsTable() {
            const tableBody = document.getElementById('sessionsTableBody');
            
            if (!currentUser.history || currentUser.history.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No practice sessions yet. Start practicing to see your progress!</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            
            // Show recent 10 sessions
            currentUser.history.slice(0, 10).forEach(session => {
                const row = document.createElement('tr');
                
                const date = new Date(session.created_at).toLocaleDateString();
                const drillName = session.drills ? session.drills.name : session.drill_id;
                const resultLabel = session.drills ? session.drills.result_label : 'result';
                
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${drillName}</td>
                    <td>${session.duration_minutes} min</td>
                    <td>${session.result} ${resultLabel}</td>
                    <td>${session.tokens_earned}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateTotalsSummary() {
            if (!currentUser.history) return;

            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfYear = new Date(now.getFullYear(), 0, 1);

            let weeklyCount = 0, monthlyCount = 0, yearlyCount = 0;
            let weeklyMinutes = 0, monthlyMinutes = 0, yearlyMinutes = 0;

            currentUser.history.forEach(session => {
                const sessionDate = new Date(session.created_at);
                
                if (sessionDate >= startOfWeek) {
                    weeklyCount++;
                    weeklyMinutes += session.duration_minutes;
                }
                if (sessionDate >= startOfMonth) {
                    monthlyCount++;
                    monthlyMinutes += session.duration_minutes;
                }
                if (sessionDate >= startOfYear) {
                    yearlyCount++;
                    yearlyMinutes += session.duration_minutes;
                }
            });

            document.getElementById('weeklyTotal').textContent = weeklyCount;
            document.getElementById('monthlyTotal').textContent = monthlyCount;
            document.getElementById('yearlyTotal').textContent = yearlyCount;
            document.getElementById('weeklyMinutes').textContent = weeklyMinutes;
            document.getElementById('monthlyMinutes').textContent = monthlyMinutes;
            document.getElementById('yearlyMinutes').textContent = yearlyMinutes;
        }

        // ===== LEADERBOARD =====
        let currentLeaderboardPeriod = 'daily';

        function switchLeaderboardPeriod(period) {
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.period === period) {
                    btn.classList.add('active');
                }
            });

            currentLeaderboardPeriod = period;
            loadLeaderboard(period);
        }

        async function loadLeaderboard(period) {
            const tableBody = document.getElementById('leaderboardTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">Loading leaderboard...</td></tr>';

            try {
                let dateFilter = '';
                const now = new Date();
                
                switch (period) {
                    case 'daily':
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        dateFilter = today.toISOString();
                        break;
                    case 'weekly':
                        const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                        dateFilter = startOfWeek.toISOString();
                        break;
                    case 'monthly':
                        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                        dateFilter = startOfMonth.toISOString();
                        break;
                    case 'alltime':
                        // No date filter for all time
                        break;
                }

                // Get leaderboard data from database
                let query = supabase
                    .from('practice_sessions')
                    .select(`
                        player_id,
                        duration_minutes,
                        tokens_earned,
                        created_at,
                        players(display_name)
                    `);

                if (dateFilter) {
                    query = query.gte('created_at', dateFilter);
                }

                const { data: sessions, error } = await query;

                if (error) throw error;

                // Group by player and calculate totals
                const playerStats = {};
                
                sessions.forEach(session => {
                    const playerId = session.player_id;
                    const playerName = session.players ? session.players.display_name : 'Unknown Player';
                    
                    if (!playerStats[playerId]) {
                        playerStats[playerId] = {
                            name: playerName,
                            sessions: 0,
                            minutes: 0,
                            tokens: 0
                        };
                    }
                    
                    playerStats[playerId].sessions++;
                    playerStats[playerId].minutes += session.duration_minutes;
                    playerStats[playerId].tokens += session.tokens_earned;
                });

                // Convert to array and sort by sessions (then by minutes as tiebreaker)
                const leaderboard = Object.entries(playerStats)
                    .map(([playerId, stats]) => ({
                        playerId: parseInt(playerId),
                        ...stats
                    }))
                    .sort((a, b) => {
                        if (b.sessions !== a.sessions) {
                            return b.sessions - a.sessions;
                        }
                        return b.minutes - a.minutes;
                    });

                // Update table
                updateLeaderboardTable(leaderboard);

            } catch (error) {
                console.error('Error loading leaderboard:', error);
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #ff6b6b;">Failed to load leaderboard. Please try again.</td></tr>';
            }
        }

        function updateLeaderboardTable(leaderboard) {
            const tableBody = document.getElementById('leaderboardTableBody');
            
            if (leaderboard.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No data available for this period.</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            
            leaderboard.forEach((player, index) => {
                const row = document.createElement('tr');
                const rank = index + 1;
                const isCurrentUser = player.playerId === currentUser.id;
                
                if (isCurrentUser) {
                    row.classList.add('current-user');
                }
                
                let rankClass = '';
                if (rank === 1) rankClass = 'rank-1';
                else if (rank === 2) rankClass = 'rank-2';
                else if (rank === 3) rankClass = 'rank-3';
                
                row.innerHTML = `
                    <td class="rank-cell ${rankClass}">${rank}</td>
                    <td class="player-name">${player.name}${isCurrentUser ? ' (You)' : ''}</td>
                    <td>${player.sessions}</td>
                    <td>${player.minutes}</td>
                    <td>${player.tokens}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // ===== PROFILE FUNCTIONS =====
        function setupProfileForm() {
            // Populate avatar options
            const avatarOptions = document.getElementById('avatarOptions');
            avatarOptions.innerHTML = '';
            
            AVATAR_OPTIONS.forEach(avatar => {
                const option = document.createElement('div');
                option.className = 'avatar-option';
                option.textContent = avatar;
                option.addEventListener('click', () => selectAvatar(avatar));
                avatarOptions.appendChild(option);
            });

            // Populate states dropdown
            const stateSelect = document.getElementById('profileState');
            stateSelect.innerHTML = '<option value="">Select your state</option>';
            
            US_STATES.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
        }

        function loadProfileData() {
            // Load current user profile data
            document.getElementById('profileDisplayName').textContent = currentUser.name;
            document.getElementById('profileLevel').textContent = currentUser.level;
            document.getElementById('profileTokens').textContent = currentUser.tokens;
            
            // Load profile form data
            document.getElementById('profileName').value = currentUser.name || '';
            document.getElementById('profileTeam').value = currentUser.team_name || '';
            document.getElementById('profileFavoritePlayer').value = currentUser.favorite_player || '';
            document.getElementById('profileState').value = currentUser.state || '';
            document.getElementById('profileAge').value = currentUser.age || '';
            
            // Set avatar
            const avatar = currentUser.avatar || '‚öΩ';
            document.getElementById('avatarDisplay').textContent = avatar;
            updateAvatarSelection(avatar);
            
            // Set favorite foot
            const foot = currentUser.favorite_foot || 'R';
            document.querySelectorAll('.foot-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.foot === foot) {
                    btn.classList.add('selected');
                }
            });
        }

        function selectAvatar(avatar) {
            document.getElementById('avatarDisplay').textContent = avatar;
            updateAvatarSelection(avatar);
        }

        function updateAvatarSelection(selectedAvatar) {
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('selected');
                if (option.textContent === selectedAvatar) {
                    option.classList.add('selected');
                }
            });
        }

        function selectFoot(selectedBtn) {
            document.querySelectorAll('.foot-btn').forEach(btn => btn.classList.remove('selected'));
            selectedBtn.classList.add('selected');
        }

        function toggleAvatarSelection() {
            const options = document.getElementById('avatarOptions');
            options.style.display = options.style.display === 'none' ? 'grid' : 'none';
        }

        async function saveProfile() {
            const saveBtn = document.getElementById('saveProfile');
            saveBtn.disabled = true;
            saveBtn.textContent = 'üíæ Saving...';

            try {
                const profileData = {
                    display_name: document.getElementById('profileName').value.trim(),
                    avatar: document.getElementById('avatarDisplay').textContent,
                    team_name: document.getElementById('profileTeam').value.trim(),
                    favorite_foot: document.querySelector('.foot-btn.selected')?.dataset.foot || 'R',
                    favorite_player: document.getElementById('profileFavoritePlayer').value.trim(),
                    state: document.getElementById('profileState').value,
                    age: parseInt(document.getElementById('profileAge').value) || null
                };

                // Validate required fields
                if (!profileData.display_name) {
                    throw new Error('Display name is required');
                }

                if (profileData.age && (profileData.age < 5 || profileData.age > 99)) {
                    throw new Error('Please enter a valid age between 5 and 99');
                }

                // Update database
                const { error } = await supabase
                    .from('players')
                    .update(profileData)
                    .eq('id', currentUser.id);

                if (error) throw error;

                // Update local user data
                Object.assign(currentUser, profileData);
                currentUser.name = profileData.display_name;

                // Update displays
                updatePlayerDisplay();
                loadProfileData();

                showAchievement('‚úÖ Profile updated successfully!');

            } catch (error) {
                console.error('Error saving profile:', error);
                showError(error.message || 'Failed to save profile. Please try again.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save Profile';
            }
        }

        // ===== AI COACH FUNCTIONS =====
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message to chat
            addChatMessage(message, 'user');
            input.value = '';

            // Get AI response
            await getCoachResponse(message);
        }

        async function sendQuickQuestion(questionType) {
            const questions = {
                analyze: "Can you analyze my recent practice progress and give me insights?",
                improve: "What specific areas should I focus on to improve my soccer skills?",
                motivation: "I need some motivation to keep practicing. Can you help?",
                drills: "What drills would you recommend based on my current skill level?"
            };

            const message = questions[questionType];
            if (!message) return;

            // Add user message to chat
            addChatMessage(message, 'user');

            // Get AI response
            await getCoachResponse(message);
        }

        function addChatMessage(message, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
            } else {
                messageDiv.innerHTML = `<strong>Coach Sarah:</strong> ${message}`;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Store in chat history
            chatHistory.push({ sender, message, timestamp: new Date() });
        }

        async function getCoachResponse(userMessage) {
            const sendBtn = document.getElementById('chatSendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';

            try {
                // Try to call backend API for AI response
                const response = await fetch(`${BACKEND_URL}/api/coach`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        playerId: currentUser.id
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    addChatMessage(data.response, 'coach');
                } else {
                    throw new Error('Backend not available');
                }

            } catch (error) {
                console.log('Backend not available, using fallback responses');
                
                // Fallback responses when backend is not available
                const fallbackResponses = [
                    "Great question! üåü Based on your recent practice sessions, I can see you're making excellent progress. Remember, every professional player started exactly where you are now. The key is consistent practice - your brain forms stronger neural pathways each time you repeat a skill. Keep focusing on proper technique over speed, and celebrate every small improvement! You're building the foundation for greatness! ‚öΩüí™",
                    
                    "I love your dedication! üî• From what I can see, you're developing really well. Here's what neuroscience tells us: your brain is most adaptable when you practice with focus and intention. Try breaking down complex skills into smaller parts, master each part, then combine them. This 'chunking' method is how elite athletes train their muscle memory. You're on the right track - keep pushing yourself! üöÄ",
                    
                    "Your progress is inspiring! üèÜ I notice you're putting in consistent effort, which is the #1 predictor of success in sports. Your brain releases growth factors during practice that literally make you smarter and more coordinated. Each session builds on the last one. My advice? Focus on your favorite drills but also challenge yourself with new ones. Variety keeps your brain engaged and accelerates learning. You've got this! ‚≠ê",
                    
                    "Fantastic work ethic! üíØ The fact that you're asking for guidance shows you have a growth mindset - that's the difference between good players and great ones. Your brain's neuroplasticity means you can literally rewire yourself to become more skilled. Focus on quality repetitions, visualize success before each drill, and remember that mistakes are just learning opportunities. Every touch of the ball is making you better! üéØ"
                ];

                // Use a random response for now
                const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                
                // Simulate thinking time
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                addChatMessage(randomResponse, 'coach');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send üöÄ';
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('authSuccess');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 3000);
        }

        function showAchievement(message) {
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `<h3>${message}</h3>`;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 3000);
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                currentUser = null;
                currentSession = null;
                if (timer) clearInterval(timer);
                
                // Reset forms
                document.getElementById('authUsername').value = '';
                document.getElementById('authEmail').value = '';
                document.getElementById('authError').classList.add('hidden');
                document.getElementById('authSuccess').classList.add('hidden');
                
                // Show auth screen
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
                
                // Reset to signin mode
                isAuthMode = 'signin';
                document.getElementById('authSubmit').textContent = 'Sign In';
                document.getElementById('authToggle').textContent = 'New player? Create account';
            }
        }
    </script>
</body>
</html><!DOCTYPE html>
